<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Discord éŠæˆ²é€šçŸ¥ç³»çµ±</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        width: 90%;
        text-align: center;
      }

      .status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 10px;
        font-weight: bold;
      }

      .status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .status.connected .status-dot {
        background: #28a745;
      }

      .status.disconnected .status-dot {
        background: #dc3545;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
        font-size: 2em;
      }

      .info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: left;
      }

      .info h3 {
        color: #495057;
        margin-bottom: 10px;
      }

      .info ul {
        color: #6c757d;
        line-height: 1.6;
      }

      .notifications {
        margin-top: 30px;
        max-height: 400px;
        overflow-y: auto;
      }

      .notification {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
        text-align: left;
        animation: slideIn 0.5s ease-out;
      }

      .notification.game {
        background: #d1ecf1;
        border-color: #bee5eb;
      }

      .notification-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 10px;
      }

      .notification-title {
        font-weight: bold;
        color: #004085;
        font-size: 1.1em;
      }

      .notification-time {
        font-size: 0.8em;
        color: #6c757d;
      }

      .notification-content {
        color: #333;
        line-height: 1.4;
      }

      .notification-details {
        margin-top: 10px;
        font-size: 0.9em;
        color: #666;
        border-top: 1px solid #eee;
        padding-top: 10px;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
      }

      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-title {
        font-size: 1.5em;
        margin-bottom: 15px;
        color: #333;
      }

      .modal-message {
        font-size: 1.2em;
        margin-bottom: 20px;
        color: #555;
      }

      .modal-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: left;
        font-size: 0.9em;
        color: #666;
      }

      .close-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1em;
        transition: background 0.3s;
      }

      .close-btn:hover {
        background: #0056b3;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .stat-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-number {
        font-size: 1.5em;
        font-weight: bold;
        color: #007bff;
      }

      .stat-label {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ® éŠæˆ²é€šçŸ¥ç³»çµ±</h1>

      <div id="status" class="status disconnected">
        <div class="status-dot"></div>
        <span id="statusText">é€£æ¥ä¸­...</span>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="clientCount">0</div>
          <div class="stat-label">é€£ç·šç”¨æˆ¶</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="notificationCount">0</div>
          <div class="stat-label">ä»Šæ—¥é€šçŸ¥</div>
        </div>
      </div>

      <div class="info">
        <h3>ğŸ“‹ ç³»çµ±èªªæ˜</h3>
        <ul>
          <li>ç›£æ§æŒ‡å®šçš„ Discord é »é“</li>
          <li>ç•¶æœ‰äººç™¼é€éŠæˆ²ç›¸é—œè¨Šæ¯æ™‚ç«‹å³é€šçŸ¥</li>
          <li>æ”¯æ´é—œéµå­—ï¼šç‹å¯ä»¥æ‰“ã€é–‹åœ˜ã€çµ„éšŠã€ä¾†ç©ç­‰</li>
          <li>ä¿æŒæ­¤é é¢é–‹å•Ÿä»¥æ¥æ”¶å³æ™‚é€šçŸ¥</li>
        </ul>
      </div>

      <div class="notifications">
        <h3>ğŸ“¢ æœ€æ–°é€šçŸ¥</h3>
        <div id="notificationList"></div>
      </div>
    </div>

    <!-- å½ˆçª—é€šçŸ¥ -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <div class="modal-title" id="modalTitle">ğŸ® éŠæˆ²é€šçŸ¥</div>
        <div class="modal-message" id="modalMessage"></div>
        <div class="modal-details" id="modalDetails"></div>
        <button class="close-btn" onclick="closeModal()">ç¢ºå®š</button>
      </div>
    </div>

    <script>
      let ws;
      let notificationCount = 0;
      let reconnectInterval;

      // åˆå§‹åŒ–
      function init() {
        connectWebSocket();
        updateStats();
      }

      // WebSocket é€£æ¥
      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}`;

        ws = new WebSocket(wsUrl);

        ws.onopen = function () {
          console.log("WebSocket é€£æ¥æˆåŠŸ");
          updateStatus(true);
          clearInterval(reconnectInterval);
        };

        ws.onmessage = function (event) {
          const data = JSON.parse(event.data);
          handleMessage(data);
        };

        ws.onclose = function () {
          console.log("WebSocket é€£æ¥é—œé–‰");
          updateStatus(false);
          // è‡ªå‹•é‡é€£
          reconnectInterval = setInterval(connectWebSocket, 5000);
        };

        ws.onerror = function (error) {
          console.error("WebSocket éŒ¯èª¤:", error);
          updateStatus(false);
        };
      }

      // è™•ç†è¨Šæ¯
      function handleMessage(data) {
        switch (data.type) {
          case "connection":
            console.log("é€£æ¥è¨Šæ¯:", data.message);
            break;
          case "game_notification":
            showNotification(data);
            addNotificationToList(data);
            notificationCount++;
            updateStats();
            break;
        }
      }

      // é¡¯ç¤ºå½ˆçª—é€šçŸ¥
      function showNotification(data) {
        document.getElementById("modalTitle").textContent = data.title;
        document.getElementById("modalMessage").textContent = data.message;

        if (data.details) {
          const details = `
                    <strong>ç™¼é€è€…:</strong> ${data.details.user}<br>
                    <strong>é »é“:</strong> ${data.details.channel}<br>
                    <strong>ä¼ºæœå™¨:</strong> ${data.details.server}<br>
                    <strong>åŸå§‹è¨Šæ¯:</strong> ${data.details.originalMessage}
                `;
          document.getElementById("modalDetails").innerHTML = details;
        }

        document.getElementById("modal").style.display = "block";

        // æ’­æ”¾é€šçŸ¥éŸ³æ•ˆï¼ˆå¦‚æœæ”¯æ´ï¼‰
        playNotificationSound();
      }

      // æ·»åŠ é€šçŸ¥åˆ°åˆ—è¡¨
      function addNotificationToList(data) {
        const notificationList = document.getElementById("notificationList");
        const notification = document.createElement("div");
        notification.className = "notification game";

        const time = new Date(data.details.timestamp).toLocaleTimeString();

        notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">${data.title}</div>
                    <div class="notification-time">${time}</div>
                </div>
                <div class="notification-content">${data.message}</div>
                <div class="notification-details">
                    <strong>ç™¼é€è€…:</strong> ${data.details.user} | 
                    <strong>é »é“:</strong> ${data.details.channel}
                </div>
            `;

        notificationList.insertBefore(
          notification,
          notificationList.firstChild
        );

        // é™åˆ¶é¡¯ç¤ºæœ€æ–° 10 æ¢é€šçŸ¥
        while (notificationList.children.length > 10) {
          notificationList.removeChild(notificationList.lastChild);
        }
      }

      // é—œé–‰å½ˆçª—
      function closeModal() {
        document.getElementById("modal").style.display = "none";
      }

      // æ›´æ–°é€£æ¥ç‹€æ…‹
      function updateStatus(connected) {
        const status = document.getElementById("status");
        const statusText = document.getElementById("statusText");

        if (connected) {
          status.className = "status connected";
          statusText.textContent = "å·²é€£æ¥";
        } else {
          status.className = "status disconnected";
          statusText.textContent = "é€£æ¥ä¸­...";
        }
      }

      // æ›´æ–°çµ±è¨ˆè³‡æ–™
      function updateStats() {
        document.getElementById("notificationCount").textContent =
          notificationCount;

        // ç²å–ç³»çµ±ç‹€æ…‹
        fetch("/api/status")
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("clientCount").textContent =
              data.connectedClients;
          })
          .catch((error) => console.error("ç²å–ç‹€æ…‹å¤±æ•—:", error));
      }

      // æ’­æ”¾é€šçŸ¥éŸ³æ•ˆ
      function playNotificationSound() {
        // å‰µå»ºéŸ³æ•ˆï¼ˆç°¡å–®çš„ beep è²ï¼‰
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = "sine";

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.5
        );

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      }

      // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
      window.onclick = function (event) {
        const modal = document.getElementById("modal");
        if (event.target === modal) {
          closeModal();
        }
      };

      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      window.onload = init;

      // é é¢é—œé–‰æ™‚æ¸…ç†
      window.onbeforeunload = function () {
        if (ws) {
          ws.close();
        }
      };
    </script>
  </body>
</html>
